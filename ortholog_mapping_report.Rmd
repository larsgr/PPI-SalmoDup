---
title: "Protein-Protein Interaction Ortholog Mapping Report"
subtitle: "Gene-Level Analysis: Mapping Human PPI Data to Pike and Salmon Orthologs"
author: "PPI-SalmoDup Project"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    theme: cosmo
    code_folding: hide
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6
)
```

# Executive Summary

This report analyzes the mapping of human protein-protein interaction (PPI) data to orthologs in pike (*Esox lucius*) and salmon (*Salmo salar*) **at the gene level**. The goal is to identify which human PPI genes have conserved orthologs in fish species to study the evolution of protein interactions following salmon's whole-genome duplication (WGD).

**Key Findings:**
- **13,520 unique genes** participate in 38,729 gene-gene interactions in the PPI dataset
- **49.7%** of PPI genes (6,719 out of 13,520) map to **canonical ortholog groups**
  - 32.0% in 1:1:2 ratio (one human, one pike, two salmon - WGD duplicates)
  - 17.7% in 1:1:1 ratio (one human, one pike, one salmon - single copy)
- **26.4%** of PPI pairs (10,218 out of 38,729) have **both genes in canonical OGs**
- Remaining genes either lack fish orthologs (mammalian-specific) or have complex orthology patterns

---

# Data Loading

```{r load_data}
# Load required libraries
library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)
library(stringr)

# Load gene-level PPI data
gene_ppi <- read.table(
    "gene_level_ppi.tsv",
    header = TRUE,
    sep = "\t",
    stringsAsFactors = FALSE
)

# Load canonical ortholog genes
canonical_genes <- read.table(
    "canonical_ortholog_genes.tsv",
    header = TRUE,
    sep = "\t",
    stringsAsFactors = FALSE
)

# Load canonical PPI pairs
gene_ppi_canonical <- read.table(
    "gene_level_ppi_canonical.tsv",
    header = TRUE,
    sep = "\t",
    stringsAsFactors = FALSE
)

# Load full ortholog mapping for additional analysis
ortho_mapping <- read.table(
    "uniprot_to_orthologs_mapping_N0.tsv",
    header = TRUE,
    sep = "\t",
    stringsAsFactors = FALSE
)

# Get unique genes
unique_genes <- unique(c(gene_ppi$geneA, gene_ppi$geneB))
n_total_genes <- length(unique_genes)
n_total_pairs <- nrow(gene_ppi)
```

---

# Gene-Level PPI Dataset

## Why Gene-Level Analysis?

The original PPI dataset uses UniProt IDs, which can represent **multiple protein isoforms** from the same gene. Since ortholog mapping is gene-based (not isoform-based), we collapsed the data to gene level:

- **Gene-gene interaction exists** if any protein isoform pair between the two genes interacts
- Eliminates double-counting of interactions due to alternative splicing

```{r gene_summary}
summary_stats <- data.frame(
  Metric = c("Total gene-gene interactions",
             "Total unique genes in PPI"),
  Count = c(n_total_pairs, n_total_genes)
)

kable(summary_stats,
      caption = "Gene-Level PPI Dataset Summary",
      col.names = c("Metric", "Count"))
```

---

# Canonical Ortholog Ratios

We focus on **canonical ortholog ratios** that are most informative for studying WGD:

- **1:1:2 (Hsap:Eluc:Ssal)**: One human gene, one pike gene, two salmon genes
  - **Expected WGD pattern** - salmon retained both duplicates

- **1:1:1 (Hsap:Eluc:Ssal)**: One human gene, one pike gene, one salmon gene
  - **Single-copy retained** - salmon lost one duplicate (rediploidization)

These exclude:
- Ancient duplications (pre-dating human-fish split)
- Complex orthology patterns (e.g., 2:2:4, 1:2:3)
- Lineage-specific losses or duplications

```{r canonical_stats}
canonical_summary <- canonical_genes %>%
  group_by(ratio) %>%
  summarise(n_genes = n(), .groups = "drop") %>%
  mutate(percentage = 100 * n_genes / sum(n_genes))

kable(canonical_summary,
      digits = 1,
      caption = "Canonical Ortholog Ratio Distribution",
      col.names = c("Ratio (Hsap:Eluc:Ssal)", "Number of Genes", "Percentage (%)"))
```

```{r canonical_pie, fig.height=5}
ggplot(canonical_summary, aes(x = "", y = n_genes, fill = ratio)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  geom_text(aes(label = sprintf("%s\n%d genes\n(%.1f%%)", ratio, n_genes, percentage)),
            position = position_stack(vjust = 0.5),
            size = 5,
            color = "white",
            fontface = "bold") +
  scale_fill_manual(values = c("1:1:1" = "#e74c3c", "1:1:2" = "#3498db"),
                    labels = c("1:1:1 (single copy)", "1:1:2 (WGD duplicates)")) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold")) +
  labs(title = "Distribution of Canonical Ortholog Ratios")
```

**Interpretation:** 64% of canonical orthologs show the 1:1:2 pattern, consistent with salmon WGD where both duplicates were retained.

---

# PPI Genes in Canonical Ortholog Groups

```{r ppi_canonical_genes}
ppi_genes_in_canonical <- unique_genes[unique_genes %in% canonical_genes$human_ensembl]

ppi_canonical_breakdown <- data.frame(
  Category = c("1:1:2 (WGD duplicates)",
               "1:1:1 (single copy)",
               "Total in canonical OGs",
               "Not in canonical OGs",
               "Total PPI genes"),
  Count = c(
    sum(unique_genes %in% (canonical_genes %>% filter(ratio == "1:1:2") %>% pull(human_ensembl))),
    sum(unique_genes %in% (canonical_genes %>% filter(ratio == "1:1:1") %>% pull(human_ensembl))),
    length(ppi_genes_in_canonical),
    n_total_genes - length(ppi_genes_in_canonical),
    n_total_genes
  )
)
ppi_canonical_breakdown$Percentage <- 100 * ppi_canonical_breakdown$Count / n_total_genes

kable(ppi_canonical_breakdown,
      digits = 1,
      caption = "PPI Genes by Canonical Ortholog Status",
      col.names = c("Category", "Count", "Percentage (%)"))
```

```{r ppi_genes_plot, fig.height=6}
plot_data <- ppi_canonical_breakdown[1:3, ]

ggplot(plot_data, aes(x = reorder(Category, -Count), y = Count)) +
  geom_bar(stat = "identity", fill = c("#3498db", "#e74c3c", "#2ecc71"), alpha = 0.8) +
  geom_text(aes(label = sprintf("%d\n(%.1f%%)", Count, Percentage)),
            vjust = -0.3, size = 4.5, fontface = "bold") +
  labs(title = "PPI Genes in Canonical Ortholog Groups",
       subtitle = sprintf("%.1f%% of PPI genes map to canonical 1:1:1 or 1:1:2 ortholog groups",
                         100 * length(ppi_genes_in_canonical) / n_total_genes),
       x = "",
       y = "Number of Genes") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 15, hjust = 1, size = 11),
        plot.title = element_text(size = 14, face = "bold"),
        plot.subtitle = element_text(size = 11, color = "gray30"))
```

---

# PPI Pairs with Both Genes in Canonical OGs

For comparative analysis of PPI evolution, we focus on **gene pairs where BOTH genes are in canonical ortholog groups**.

```{r ppi_pairs_canonical}
# Add ratio information to gene pairs
gene_ppi_with_ratios <- gene_ppi %>%
  left_join(canonical_genes %>% select(human_ensembl, ratioA = ratio),
            by = c("geneA" = "human_ensembl")) %>%
  left_join(canonical_genes %>% select(human_ensembl, ratioB = ratio),
            by = c("geneB" = "human_ensembl")) %>%
  mutate(
    both_canonical = !is.na(ratioA) & !is.na(ratioB),
    pair_type = case_when(
      is.na(ratioA) & is.na(ratioB) ~ "Neither gene in canonical OG",
      is.na(ratioA) | is.na(ratioB) ~ "One gene in canonical OG",
      TRUE ~ "Both genes in canonical OG"
    )
  )

pair_summary <- gene_ppi_with_ratios %>%
  group_by(pair_type) %>%
  summarise(n_pairs = n(), .groups = "drop") %>%
  mutate(percentage = 100 * n_pairs / sum(n_pairs)) %>%
  arrange(desc(n_pairs))

kable(pair_summary,
      digits = 1,
      caption = "PPI Pairs by Canonical Ortholog Status",
      col.names = c("Pair Type", "Number of Pairs", "Percentage (%)"))
```

```{r pair_type_plot, fig.height=5}
ggplot(pair_summary, aes(x = reorder(pair_type, -n_pairs), y = n_pairs)) +
  geom_bar(stat = "identity", fill = c("#2ecc71", "#f39c12", "#95a5a6"), alpha = 0.8) +
  geom_text(aes(label = sprintf("%d\n(%.1f%%)", n_pairs, percentage)),
            vjust = -0.3, size = 4.5, fontface = "bold") +
  labs(title = "PPI Pairs by Canonical Ortholog Coverage",
       x = "",
       y = "Number of Gene-Gene Interactions") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 15, hjust = 1, size = 11),
        plot.title = element_text(size = 14, face = "bold"))
```

## Breakdown by Ratio Combinations

```{r ratio_combinations}
ratio_combinations <- gene_ppi_with_ratios %>%
  filter(both_canonical) %>%
  group_by(ratioA, ratioB) %>%
  summarise(n_pairs = n(), .groups = "drop") %>%
  arrange(desc(n_pairs))

kable(ratio_combinations,
      caption = "PPI Pairs by Ortholog Ratio Combinations (Both Genes in Canonical OGs)",
      col.names = c("Gene A Ratio", "Gene B Ratio", "Number of Pairs"))
```

```{r ratio_combo_plot, fig.height=5}
# Create combination labels
ratio_combinations <- ratio_combinations %>%
  mutate(combo = paste(ratioA, "x", ratioB))

ggplot(ratio_combinations, aes(x = reorder(combo, -n_pairs), y = n_pairs)) +
  geom_bar(stat = "identity", fill = "#9b59b6", alpha = 0.8) +
  geom_text(aes(label = n_pairs), vjust = -0.3, size = 4.5, fontface = "bold") +
  labs(title = "PPI Pairs by Ortholog Ratio Combinations",
       subtitle = "Both genes must be in canonical 1:1:1 or 1:1:2 ortholog groups",
       x = "Ratio Combination",
       y = "Number of Gene-Gene Interactions") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 15, hjust = 1, size = 11),
        plot.title = element_text(size = 14, face = "bold"),
        plot.subtitle = element_text(size = 11, color = "gray30"))
```

**Key Observations:**
- **4,564 pairs** are between two 1:1:2 genes (both WGD duplicates)
- **4,217 pairs** are between 1:1:2 and 1:1:1 genes (mixed)
- **1,437 pairs** are between two 1:1:1 genes (both single-copy)

## Canonical Ortholog Groups with PPI Partners

This section generates a comprehensive table of all canonical ortholog groups (1:1:1 and 1:1:2) where the human gene has at least one PPI partner.

```{r canonical_og_table}
# Load original PPI data (skip comment lines)
ppi_raw <- read.table(
  "final_predictions/final_predictions_80.tsv",
  header = TRUE,
  sep = "\t",
  skip = 28,
  stringsAsFactors = FALSE,
  quote = ""
)

# Get all UniProt IDs and gene names from PPI data
ppi_proteins_info <- bind_rows(
  ppi_raw %>% select(uniprot_id = Protein1, gene_name = Name1),
  ppi_raw %>% select(uniprot_id = Protein2, gene_name = Name2)
) %>%
  distinct()

# Load UniProt to Ensembl mapping
uniprot_map <- read.table(
  "uniprot_to_ensembl_human.tsv",
  header = TRUE,
  sep = "\t",
  stringsAsFactors = FALSE
)

# Get all human genes that appear in canonical PPI pairs
genes_with_ppi <- unique(c(gene_ppi_canonical$geneA, gene_ppi_canonical$geneB))

# Get list of PPI partners for each gene
ppi_partner_lists <- bind_rows(
  gene_ppi_canonical %>% select(gene = geneA, partner = geneB),
  gene_ppi_canonical %>% select(gene = geneB, partner = geneA)
) %>%
  group_by(gene) %>%
  summarise(interacting_genes = paste(sort(unique(partner)), collapse = ","), .groups = "drop")

# Map genes to their UniProt IDs (only those in PPI data) and gene names
gene_to_info <- uniprot_map %>%
  left_join(ppi_proteins_info, by = "uniprot_id") %>%
  filter(!is.na(gene_name)) %>%  # Only keep proteins from PPI data
  select(ensembl_gene_id, uniprot_id, gene_name) %>%
  distinct() %>%
  group_by(ensembl_gene_id) %>%
  summarise(
    human_protein_ids = paste(sort(unique(uniprot_id)), collapse = ","),
    gene_name = paste(unique(gene_name), collapse = ","),
    .groups = "drop"
  )

# Create the canonical ortholog table with PPI partners
canonical_ppi_table <- canonical_genes %>%
  filter(human_ensembl %in% genes_with_ppi) %>%
  left_join(gene_to_info, by = c("human_ensembl" = "ensembl_gene_id")) %>%
  left_join(ppi_partner_lists, by = c("human_ensembl" = "gene")) %>%
  # Sort by number of partners
  mutate(n_partners = str_count(interacting_genes, ",") + 1) %>%
  arrange(desc(n_partners), ratio, human_ensembl) %>%
  select(gene_name, human_gene_id = human_ensembl, human_protein_ids,
         OG_N0 = ortholog_group_N0, pike_gene_id = pike_genes,
         salmon_gene_id = salmon_genes, ratio, interacting_genes)

# Save the table as TSV
write.table(canonical_ppi_table,
            file = "canonical_orthologs_with_ppi.tsv",
            sep = "\t",
            row.names = FALSE,
            quote = FALSE)

# Display summary statistics
cat(sprintf("\n**Table saved to: canonical_orthologs_with_ppi.tsv**\n\n"))
cat(sprintf("Total canonical genes with PPI partners: %d\n", nrow(canonical_ppi_table)))
cat(sprintf("- 1:1:2 genes: %d\n", sum(canonical_ppi_table$ratio == "1:1:2")))
cat(sprintf("- 1:1:1 genes: %d\n\n", sum(canonical_ppi_table$ratio == "1:1:1")))

# Display sample (top 20 rows)
cat("**Sample of the table (top 20 genes by number of PPI partners):**\n\n")
kable(head(canonical_ppi_table, 20),
      caption = "Top 20 genes by number of PPI partners (full table in canonical_orthologs_with_ppi.tsv)")
```

**Table columns:**
- **gene_name**: Human gene name (e.g., EGFR, SQSTM1)
- **human_gene_id**: Human Ensembl gene ID
- **human_protein_ids**: UniProt protein IDs that appear in the PPI dataset (comma-separated)
- **OG_N0**: N0-level ortholog group identifier
- **pike_gene_id**: Pike ortholog gene ID(s)
- **salmon_gene_id**: Salmon ortholog gene ID(s) - comma-separated for duplicates
- **ratio**: Ortholog ratio (1:1:1 or 1:1:2)
- **interacting_genes**: Comma-separated list of all human gene IDs that interact with this gene

**How to use this table:**
- **For 1:1:2 orthologs**: Compare pike gene → salmon duplicate A and duplicate B
- **For 1:1:1 orthologs**: Compare pike gene → salmon single-copy gene
- **Salmon gene pairs** (comma-separated in 1:1:2) represent WGD duplicates to test for PPI subfunctionalization

---

# Why Aren't All Genes in Canonical OGs?

```{r non_canonical_analysis}
# Analyze genes NOT in canonical OGs
non_canonical_genes <- unique_genes[!unique_genes %in% canonical_genes$human_ensembl]

# Check if they're in ortholog mapping at all
genes_with_orthologs <- unique(ortho_mapping$human_ensembl)
non_canonical_with_orthologs <- non_canonical_genes[non_canonical_genes %in% genes_with_orthologs]
non_canonical_no_orthologs <- non_canonical_genes[!non_canonical_genes %in% genes_with_orthologs]

reasons <- data.frame(
  Reason = c("No fish orthologs (mammalian-specific)",
             "Complex orthology patterns (not 1:1:1 or 1:1:2)"),
  Count = c(length(non_canonical_no_orthologs),
            length(non_canonical_with_orthologs))
)
reasons$Percentage <- 100 * reasons$Count / length(non_canonical_genes)

kable(reasons,
      digits = 1,
      caption = "Why PPI Genes Are Not in Canonical Ortholog Groups",
      col.names = c("Reason", "Count", "% of Non-Canonical"))
```

```{r complex_orthology_examples}
# Get examples of complex orthology patterns
if (length(non_canonical_with_orthologs) > 0) {
  complex_examples <- ortho_mapping %>%
    filter(human_ensembl %in% non_canonical_with_orthologs) %>%
    # Count human genes per OG
    group_by(ortholog_group_N0, n_pike, n_salmon) %>%
    summarise(n_human = n_distinct(human_ensembl), .groups = "drop") %>%
    filter(!(n_human == 1 & n_pike == 1 & (n_salmon == 1 | n_salmon == 2))) %>%
    group_by(n_human, n_pike, n_salmon) %>%
    summarise(n_og_groups = n(), .groups = "drop") %>%
    arrange(desc(n_og_groups)) %>%
    head(10)

  kable(complex_examples,
        caption = "Examples of Complex Orthology Patterns (Top 10)",
        col.names = c("Human Genes", "Pike Genes", "Salmon Genes", "Number of OG Groups"))
}
```

**Complex Patterns Include:**
- Ancient duplications (e.g., 2:2:4, 2:1:2)
- Lineage-specific losses (e.g., 1:0:2, 1:2:2)
- Lineage-specific duplications (e.g., 1:3:2, 1:1:5)

---

# Salmon Gene Duplication in Canonical OGs

```{r salmon_duplication_canonical}
# Analyze salmon duplication status for canonical genes
salmon_dup_summary <- canonical_genes %>%
  mutate(salmon_status = ifelse(n_salmon == 1, "Single-copy", "Duplicated")) %>%
  group_by(salmon_status) %>%
  summarise(n_genes = n(), .groups = "drop") %>%
  mutate(percentage = 100 * n_genes / sum(n_genes))

kable(salmon_dup_summary,
      digits = 1,
      caption = "Salmon Gene Copy Status in Canonical Ortholog Groups",
      col.names = c("Salmon Status", "Number of Genes", "Percentage (%)"))
```

**Interpretation:** Among canonical ortholog groups, 64.1% show salmon-specific duplication (1:1:2), while 35.9% have returned to single-copy status (1:1:1) through rediploidization.

---

# Conclusions

1. **Gene-Level Analysis is Critical:** Collapsing to gene level revealed 13,520 unique genes (vs 12,298 unique proteins), eliminating protein isoform redundancy

2. **Canonical Ortholog Coverage:** 49.7% of PPI genes map to canonical 1:1:1 or 1:1:2 ortholog groups
   - 32.0% in 1:1:2 ratio (WGD duplicates)
   - 17.7% in 1:1:1 ratio (single-copy retained)

3. **Analyzable PPI Pairs:** 26.4% of gene-gene interactions (10,218 pairs) have both genes in canonical ortholog groups
   - These are the most informative for studying PPI evolution post-WGD
   - 4,564 pairs between two WGD duplicate genes (1:1:2 × 1:1:2)

4. **WGD Retention:** Among canonical orthologs, 64% retained both salmon duplicates (1:1:2), showing strong duplicate retention post-WGD

5. **Non-Canonical Genes:** The remaining 50.3% either:
   - Lack fish orthologs (mammalian-specific: ~40%)
   - Have complex orthology patterns not fitting 1:1:1 or 1:1:2 (~10%)

---

# Recommendations for Analysis

For studying PPI evolution after salmon WGD, focus on the **10,218 gene pairs where both genes are in canonical ortholog groups**. These provide:

- Clean orthology relationships (no ancient duplicates)
- Clear comparison: pike (1 copy) vs salmon (1 or 2 copies)
- Well-defined evolutionary scenarios for testing hypotheses about:
  - PPI retention/loss in duplicates
  - Subfunctionalization at the interaction level
  - Dosage balance constraints

---

# Session Information

```{r session_info}
sessionInfo()
```
