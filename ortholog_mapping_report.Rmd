---
title: "PPI-SalmoDup: Human PPI Mapping to Salmon Orthologs"
author: "PPI-SalmoDup Project"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 6)
```

# Overview

This analysis maps human protein-protein interactions (PPI) to orthologs in pike (*Esox lucius*) and salmon (*Salmo salar*) to study PPI evolution after salmon's whole-genome duplication (WGD). We focus on **canonical ortholog ratios**:

- **1:1:2** (Human:Pike:Salmon) - WGD pattern, both duplicates retained
- **1:1:1** (Human:Pike:Salmon) - Single-copy retained (rediploidization)

```{r packages}
# Install packages if needed
if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
if (!requireNamespace("biomaRt", quietly = TRUE)) BiocManager::install("biomaRt")

library(biomaRt)
library(knitr)
library(tidyverse)
```

# 1. Data Download

```{r download, cache=TRUE}
# Download PPI predictions if not present
if (!file.exists("final_predictions/final_predictions_80.tsv")) {
  message("Downloading PPI predictions from Cong Lab...")
  dir.create("final_predictions", showWarnings = FALSE)
  download.file(
    "https://conglab.swmed.edu/humanPPI/downloads/final_predictions.tar.gz",
    "ppi.tar.gz", mode = "wb"
  )
  untar("ppi.tar.gz")
  file.remove("ppi.tar.gz")
}

# Download ortholog table if not present
if (!file.exists("OGtbl.tsv")) {
  message("Downloading OGtbl.tsv from SalmoBase (115MB)...")
  download.file(
    "https://salmobase.org/datafiles/orthology/2021-11/Ortho_pipeline/OGtbl.tsv",
    "OGtbl.tsv", mode = "wb"
  )
}
```

# 2. Load Data

```{r load_data, cache=TRUE}
# Load PPI predictions (skip comment header)
ppi_raw <- read_tsv(
  "final_predictions/final_predictions_80.tsv",
  comment = "#", show_col_types = FALSE
)

# Load ortholog table
og_table <- read_tsv("OGtbl.tsv", show_col_types = FALSE)

tibble(
  Dataset = c("PPI interactions", "Ortholog table entries"),
  Count = c(nrow(ppi_raw), nrow(og_table))
) %>% kable(caption = "Input data summary")
```

# 3. UniProt to Ensembl Mapping

```{r biomart, cache=TRUE}
# Cache biomaRt results for reproducibility
cache_file <- ".biomart_cache_uniprot_ensembl.tsv"

if (file.exists(cache_file)) {
  message("Loading cached UniProt-Ensembl mapping...")
  uniprot_ensembl <- read_tsv(cache_file, show_col_types = FALSE)
} else {
  message("Querying Ensembl for human UniProt to gene mapping (this takes a few minutes)...")
  mart <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")

  uniprot_ensembl <- getBM(
    attributes = c("ensembl_gene_id", "uniprotswissprot", "uniprotsptrembl", "external_gene_name"),
    mart = mart
  ) %>%
    as_tibble() %>%
    # Prefer SwissProt over TrEMBL
    mutate(uniprot_id = if_else(uniprotswissprot != "", uniprotswissprot, uniprotsptrembl)) %>%
    filter(uniprot_id != "") %>%
    select(ensembl_gene_id, uniprot_id, gene_name = external_gene_name) %>%
    distinct()

  # Save to cache
  write_tsv(uniprot_ensembl, cache_file)
  message("Saved biomaRt results to cache")
}

message(sprintf("Mapped %d UniProt IDs to Ensembl genes", n_distinct(uniprot_ensembl$uniprot_id)))
```

# 4. Collapse PPI to Gene Level

```{r gene_level}
# Extract all proteins from PPI data
ppi_proteins <- bind_rows(
  ppi_raw %>% select(uniprot_id = Protein1, gene_name_ppi = Name1),
  ppi_raw %>% select(uniprot_id = Protein2, gene_name_ppi = Name2)
) %>% distinct()

# Map PPI proteins to Ensembl genes
ppi_to_gene <- ppi_proteins %>%
  inner_join(uniprot_ensembl %>% select(uniprot_id, ensembl_gene_id), by = "uniprot_id")

# Create gene-level PPI (map proteins to genes, then deduplicate)
gene_ppi <- ppi_raw %>%
  inner_join(ppi_to_gene %>% select(uniprot_id, gene1 = ensembl_gene_id),
             by = c("Protein1" = "uniprot_id")) %>%
  inner_join(ppi_to_gene %>% select(uniprot_id, gene2 = ensembl_gene_id),
             by = c("Protein2" = "uniprot_id")) %>%
  # Create ordered pairs to avoid A-B and B-A duplicates
  mutate(
    geneA = if_else(gene1 < gene2, gene1, gene2),
    geneB = if_else(gene1 < gene2, gene2, gene1)
  ) %>%
  distinct(geneA, geneB)

unique_genes <- unique(c(gene_ppi$geneA, gene_ppi$geneB))

tibble(
  Metric = c("Gene-gene interactions", "Unique genes in PPI"),
  Count = c(nrow(gene_ppi), length(unique_genes))
) %>% kable(caption = "Gene-level PPI summary")
```

# 5. Map to Fish Orthologs

```{r orthologs, cache=TRUE}
# Filter OGtbl for species of interest
og_species <- og_table %>%
  filter(spc %in% c("Hsap", "Eluc", "Ssal"), !is.na(N0)) %>%
  select(geneID, spc, N0)

# Get human genes (from PPI) with their N0 groups
human_n0 <- og_species %>%
  filter(spc == "Hsap", geneID %in% unique_genes) %>%
  select(human_gene = geneID, N0)

# For each N0 group, count how many PPI genes it has (not all human genes!)
human_per_n0 <- human_n0 %>%
  group_by(N0) %>%
  summarise(n_human_ppi = n_distinct(human_gene), .groups = "drop")

# Get pike and salmon counts for each N0
fish_per_n0 <- og_species %>%
  filter(spc %in% c("Eluc", "Ssal")) %>%
  group_by(N0) %>%
  summarise(
    n_pike = sum(spc == "Eluc"),
    n_salmon = sum(spc == "Ssal"),
    pike_genes = paste(geneID[spc == "Eluc"], collapse = ","),
    salmon_genes = paste(geneID[spc == "Ssal"], collapse = ","),
    .groups = "drop"
  )

# Join counts
n0_with_counts <- human_per_n0 %>%
  left_join(fish_per_n0, by = "N0") %>%
  filter(!is.na(n_pike), !is.na(n_salmon))

# Join human genes with their ortholog info
human_orthologs <- human_n0 %>%
  left_join(n0_with_counts, by = "N0") %>%
  filter(!is.na(n_human_ppi))

message(sprintf("Found %d PPI genes with fish orthologs", nrow(human_orthologs)))
```

# 6. Canonical Ortholog Ratios

Canonical ratios are the cleanest orthology patterns for WGD analysis:

- **1:1:2**: Expected WGD pattern (both salmon duplicates retained)
- **1:1:1**: Single-copy retained (rediploidization)

```{r canonical}
# Identify canonical ortholog groups (only 1 PPI gene per N0 for human)
canonical_genes <- human_orthologs %>%
  filter(n_human_ppi == 1, n_pike == 1, n_salmon %in% c(1, 2)) %>%
  mutate(ratio = if_else(n_salmon == 2, "1:1:2", "1:1:1"))

# For summary stats
canonical_ogs <- canonical_genes %>%
  distinct(N0, ratio)

# Count PPI genes in canonical OGs
ppi_in_canonical <- unique_genes[unique_genes %in% canonical_genes$human_gene]

# Filter PPI pairs where both genes are canonical
gene_ppi_canonical <- gene_ppi %>%
  filter(geneA %in% canonical_genes$human_gene, geneB %in% canonical_genes$human_gene)

tibble(
  Metric = c(
    "Canonical OGs (1:1:2)", "Canonical OGs (1:1:1)",
    "PPI genes in canonical OGs", "PPI pairs (both genes canonical)"
  ),
  Count = c(
    sum(canonical_ogs$ratio == "1:1:2"), sum(canonical_ogs$ratio == "1:1:1"),
    length(ppi_in_canonical), nrow(gene_ppi_canonical)
  ),
  Percentage = c(
    NA, NA,
    100 * length(ppi_in_canonical) / length(unique_genes),
    100 * nrow(gene_ppi_canonical) / nrow(gene_ppi)
  )
) %>% kable(digits = 1, caption = "Canonical ortholog summary")
```

# 7. Results

## Canonical Ratio Distribution

```{r fig_ratios, fig.height=5}
canonical_summary <- canonical_genes %>%
  count(ratio) %>%
  mutate(pct = 100 * n / sum(n))

ggplot(canonical_summary, aes(x = "", y = n, fill = ratio)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y") +
  geom_text(aes(label = sprintf("%s\n%d genes\n(%.1f%%)", ratio, n, pct)),
            position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 5) +
  scale_fill_manual(values = c("1:1:1" = "#e74c3c", "1:1:2" = "#3498db"),
                    labels = c("1:1:1 (single copy)", "1:1:2 (WGD duplicates)")) +
  theme_void() +
  theme(legend.position = "bottom", legend.title = element_blank()) +
  labs(title = "Canonical Ortholog Ratio Distribution")
```

## PPI Genes by Canonical Status

```{r fig_genes}
gene_status <- tibble(
  Category = c("1:1:2 (WGD)", "1:1:1 (single)", "Not canonical"),
  Count = c(
    sum(unique_genes %in% filter(canonical_genes, ratio == "1:1:2")$human_gene),
    sum(unique_genes %in% filter(canonical_genes, ratio == "1:1:1")$human_gene),
    sum(!unique_genes %in% canonical_genes$human_gene)
  )
) %>% mutate(Pct = 100 * Count / sum(Count))

ggplot(gene_status, aes(x = fct_reorder(Category, -Count), y = Count, fill = Category)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = sprintf("%d\n(%.1f%%)", Count, Pct)), vjust = -0.2, fontface = "bold") +
  scale_fill_manual(values = c("1:1:2 (WGD)" = "#3498db", "1:1:1 (single)" = "#e74c3c", "Not canonical" = "#95a5a6")) +
  labs(title = "PPI Genes by Canonical Ortholog Status", x = "", y = "Number of genes") +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 11))
```

## PPI Pairs by Ratio Combination

```{r fig_pairs}
# Add ratio info to canonical PPI pairs
pair_ratios <- gene_ppi_canonical %>%
  left_join(canonical_genes %>% select(human_gene, ratioA = ratio), by = c("geneA" = "human_gene")) %>%
  left_join(canonical_genes %>% select(human_gene, ratioB = ratio), by = c("geneB" = "human_gene")) %>%
  count(ratioA, ratioB) %>%
  mutate(combo = paste(ratioA, "x", ratioB))

ggplot(pair_ratios, aes(x = fct_reorder(combo, -n), y = n)) +
  geom_col(fill = "#9b59b6", alpha = 0.8) +
  geom_text(aes(label = n), vjust = -0.3, fontface = "bold") +
  labs(title = "PPI Pairs by Ortholog Ratio Combination",
       subtitle = "Both genes must be in canonical OGs",
       x = "Ratio combination", y = "Number of pairs") +
  theme_minimal()
```

## Why Genes Lack Canonical Orthologs

```{r fig_reasons}
non_canonical <- unique_genes[!unique_genes %in% canonical_genes$human_gene]
has_any_orthologs <- non_canonical[non_canonical %in% human_orthologs$human_gene]

reasons <- tibble(
  Reason = c("No fish orthologs\n(mammalian-specific)", "Complex orthology\n(not 1:1:1 or 1:1:2)"),
  Count = c(length(non_canonical) - length(has_any_orthologs), length(has_any_orthologs))
)

ggplot(reasons, aes(x = fct_reorder(Reason, -Count), y = Count)) +
  geom_col(fill = c("#f39c12", "#1abc9c"), alpha = 0.8) +
  geom_text(aes(label = Count), vjust = -0.3, fontface = "bold") +
  labs(title = "Why PPI Genes Are Not in Canonical OGs", x = "", y = "Number of genes") +
  theme_minimal()
```

# 8. Output Table

The main output is `canonical_orthologs_with_ppi.tsv` containing canonical ortholog groups where the human gene participates in PPI.

```{r output_table}
# Get genes that appear in canonical PPI pairs
genes_with_canonical_ppi <- unique(c(gene_ppi_canonical$geneA, gene_ppi_canonical$geneB))

# Build PPI partner lists for each gene
ppi_partners <- bind_rows(
  gene_ppi_canonical %>% select(gene = geneA, partner = geneB),
  gene_ppi_canonical %>% select(gene = geneB, partner = geneA)
) %>%
  group_by(gene) %>%
  summarise(interacting_genes = paste(sort(unique(partner)), collapse = ","), .groups = "drop")

# Map genes to UniProt IDs that appear in PPI data
gene_to_proteins <- ppi_to_gene %>%
  group_by(ensembl_gene_id) %>%
  summarise(human_protein_ids = paste(sort(unique(uniprot_id)), collapse = ","), .groups = "drop")

# Get gene names from UniProt mapping
gene_names <- uniprot_ensembl %>%
  filter(gene_name != "") %>%
  group_by(ensembl_gene_id) %>%
  summarise(gene_name = first(gene_name), .groups = "drop")

# Create final output table
canonical_ppi_table <- canonical_genes %>%
  filter(human_gene %in% genes_with_canonical_ppi) %>%
  left_join(gene_names, by = c("human_gene" = "ensembl_gene_id")) %>%
  left_join(gene_to_proteins, by = c("human_gene" = "ensembl_gene_id")) %>%
  left_join(ppi_partners, by = c("human_gene" = "gene")) %>%
  mutate(n_partners = str_count(interacting_genes, ",") + 1) %>%
  arrange(desc(n_partners)) %>%
  select(
    gene_name,
    human_gene_id = human_gene,
    human_protein_ids,
    OG_N0 = N0,
    pike_gene_id = pike_genes,
    salmon_gene_id = salmon_genes,
    ratio,
    interacting_genes
  )

# Save output
write_tsv(canonical_ppi_table, "canonical_orthologs_with_ppi.tsv")

message(sprintf("Saved %d canonical genes with PPI partners to canonical_orthologs_with_ppi.tsv", nrow(canonical_ppi_table)))
message(sprintf("  - 1:1:2 genes: %d", sum(canonical_ppi_table$ratio == "1:1:2")))
message(sprintf("  - 1:1:1 genes: %d", sum(canonical_ppi_table$ratio == "1:1:1")))
```

**Top 20 genes by number of PPI partners:**

```{r show_table}
canonical_ppi_table %>%
  head(20) %>%
  kable(caption = "Sample of canonical_orthologs_with_ppi.tsv (top 20 by PPI partners)")
```

**Column descriptions:**

- `gene_name`: Human gene symbol
- `human_gene_id`: Human Ensembl gene ID
- `human_protein_ids`: UniProt IDs from PPI dataset (comma-separated)
- `OG_N0`: N0-level ortholog group ID
- `pike_gene_id`: Pike ortholog Ensembl ID
- `salmon_gene_id`: Salmon ortholog Ensembl ID(s) (comma-separated for 1:1:2)
- `ratio`: Ortholog ratio (1:1:1 or 1:1:2)
- `interacting_genes`: Human Ensembl IDs of PPI partners (comma-separated)

# 9. Conclusions

1. **`r sprintf("%.1f%%", 100 * length(ppi_in_canonical) / length(unique_genes))`** of PPI genes (`r length(ppi_in_canonical)` of `r length(unique_genes)`) map to canonical ortholog groups
2. **`r sprintf("%.1f%%", 100 * nrow(gene_ppi_canonical) / nrow(gene_ppi))`** of PPI pairs (`r nrow(gene_ppi_canonical)` of `r nrow(gene_ppi)`) have both genes in canonical OGs
3. Among canonical orthologs, **`r sprintf("%.1f%%", 100 * sum(canonical_genes$ratio == "1:1:2") / nrow(canonical_genes))`** show the 1:1:2 pattern (WGD duplicates retained)

These `r nrow(gene_ppi_canonical)` canonical PPI pairs are suitable for studying PPI evolution after salmon WGD.

---

**Data sources:**

- PPI predictions: [Cong et al. 2024, Science](https://doi.org/10.1126/science.adt1630)
- Ortholog groups: [SalmoBase](https://salmobase.org/)

```{r session_info}
sessionInfo()
```
